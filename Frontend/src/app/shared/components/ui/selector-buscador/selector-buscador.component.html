<div class="relative w-full">
  <!-- Label opcional -->
  @if (label()) {
    <label class="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">
      {{ label() }}
    </label>
  }

  <!-- Botón principal del selector -->
  <div class="relative">
    <button
      type="button"
      (click)="alternarDropdown()"
      (keydown)="alPresionarTecla($event)"
      [disabled]="deshabilitado()"
      class="w-full px-4 pr-10 py-2.5 sm:py-3 text-sm sm:text-base border-2 rounded-lg sm:rounded-xl transition-all bg-white text-left
             {{ deshabilitado()
                ? 'border-gray-200 bg-gray-50 cursor-not-allowed text-gray-400'
                : abierto()
                  ? 'border-teal-500 ring-2 ring-teal-200'
                  : 'border-gray-200 hover:border-teal-300 focus:ring-2 focus:ring-teal-200 focus:border-teal-500'
             }}"
    >
      <span class="{{ !opcionActual() ? 'text-gray-400' : 'text-gray-900' }}">
        {{ textoMostrado() }}
      </span>
    </button>

    <!-- Icono derecho (chevron animado) -->
    <svg
      class="absolute right-3 sm:right-4 top-1/2 transform -translate-y-1/2 w-5 h-5 pointer-events-none transition-transform duration-200
             {{ deshabilitado() ? 'text-gray-300' : 'text-gray-400' }}
             {{ abierto() ? 'rotate-180' : '' }}"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
    </svg>
  </div>

  <!-- Dropdown Panel -->
  @if (abierto()) {
    <div class="absolute z-50 w-full mt-2 bg-white border-2 border-teal-500 rounded-xl shadow-2xl overflow-hidden">
      <!-- Input de búsqueda -->
      <div class="p-3 bg-gradient-to-r from-gray-50 to-teal-50/30 border-b border-gray-200">
        <div class="relative">
          <input
            #inputBusqueda
            type="text"
            [(ngModel)]="terminoBusqueda"
            (ngModelChange)="alCambiarBusqueda()"
            (keydown)="alPresionarTecla($event)"
            placeholder="Buscar..."
            class="w-full pl-9 pr-4 py-2.5 text-sm border-2 border-gray-200 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 bg-white transition-all placeholder:text-gray-400"
          >
          <svg class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
          </svg>
          @if (terminoBusqueda()) {
            <button
              type="button"
              (click)="limpiarBusqueda()"
              class="absolute right-2 top-1/2 transform -translate-y-1/2 p-1 hover:bg-gray-100 rounded-full transition-colors"
            >
              <svg class="w-4 h-4 text-gray-400 hover:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          }
        </div>
      </div>

      <!-- Lista de opciones -->
      <div class="max-h-64 overflow-y-auto">
        <!-- Opción "Todas" o placeholder -->
        <button
          type="button"
          (click)="seleccionarOpcion(null)"
          (mouseenter)="resaltarOpcion(-1)"
          class="w-full px-4 py-3 text-left text-sm transition-all duration-150
                 {{ opcionResaltada() === -1 ? 'bg-teal-50' : 'hover:bg-gray-50' }}
                 {{ !valorSeleccionado() ? 'bg-gradient-to-r from-teal-50 to-cyan-50 text-teal-800 font-semibold border-l-4 border-teal-600' : 'text-gray-700' }}"
        >
          <div class="flex items-center justify-between">
            <span>{{ placeholder() }}</span>
            @if (!valorSeleccionado()) {
              <svg class="w-5 h-5 text-teal-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
              </svg>
            }
          </div>
        </button>

        @if (opcionesFiltradas().length === 0) {
          <!-- Sin resultados -->
          <div class="px-4 py-12 text-center text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <p class="text-sm font-semibold text-gray-600">No se encontraron resultados</p>
            <p class="text-xs mt-1 text-gray-400">Intenta con otro término de búsqueda</p>
          </div>
        } @else {
          <!-- Opciones filtradas -->
          @for (opcion of opcionesFiltradas(); track opcion.id; let i = $index) {
            <button
              type="button"
              [id]="'opcion-' + i"
              (click)="seleccionarOpcion(opcion)"
              (mouseenter)="resaltarOpcion(i)"
              class="w-full px-4 py-3 text-left text-sm transition-all duration-150 group
                     {{ i === opcionResaltada() ? 'bg-teal-50 scale-[0.99]' : 'hover:bg-gray-50' }}
                     {{ valorSeleccionado() === opcion.id ? 'bg-gradient-to-r from-teal-50 to-cyan-50 text-teal-800 font-semibold border-l-4 border-teal-600' : 'text-gray-700 border-l-4 border-transparent' }}"
            >
              <div class="flex items-center justify-between">
                <span class="truncate">{{ opcion.nombre }}</span>
                @if (valorSeleccionado() === opcion.id) {
                  <svg class="w-5 h-5 text-teal-600 flex-shrink-0 ml-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                  </svg>
                }
              </div>
            </button>
          }
        }
      </div>

      <!-- Footer con contador -->
      @if (opcionesFiltradas().length > 0) {
        <div class="px-4 py-2.5 bg-gradient-to-r from-gray-50 to-teal-50/30 border-t border-gray-200">
          <div class="flex items-center justify-center gap-2 text-xs text-gray-500">
            <svg class="w-4 h-4 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
            </svg>
            <span class="font-medium">
              {{ opcionesFiltradas().length }} {{ opcionesFiltradas().length === 1 ? 'opción disponible' : 'opciones disponibles' }}
            </span>
          </div>
        </div>
      }
    </div>

    <!-- Overlay para cerrar al hacer click fuera -->
    <div
      class="fixed inset-0 z-40"
      (click)="cerrarDropdown()"
    ></div>
  }
</div>
