# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# ğŸ—ï¸  FRONTEND DOCKERFILE - Angular 20 + Tailwind CSS + pnpm
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
# DescripciÃ³n: Multi-stage build optimizado para producciÃ³n
# - Stage 1: Build Angular app con todas las dependencias usando pnpm
# - Stage 2: Servir con nginx optimizado para SPA
# Comandos disponibles:
#   â€¢ build:prod (producciÃ³n optimizada)
#   â€¢ build:devdist (desarrollo optimizado)
#   â€¢ build:analyze (anÃ¡lisis de bundles)
# Autor: Sistema TurnosNew
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

# Argumento para elegir el comando de build (por defecto producciÃ³n)
ARG BUILD_COMMAND=build:prod

# â”€â”€â”€â”€â”€ Stage 1: Build Angular Application â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM node:22-alpine AS build

# Metadata de la imagen
LABEL maintainer="TurnosNew Team"
LABEL description="Frontend Angular 20 para Sistema de Turnos Hospitalarios"
LABEL version="1.0.0"

# Establecer directorio de trabajo
WORKDIR /app

# Instalar pnpm globalmente (mÃ¡s rÃ¡pido que npm)
RUN npm install -g pnpm@latest

# OptimizaciÃ³n de capas: copiar package files primero para aprovechar cache de Docker
COPY package*.json pnpm-lock.yaml ./

# Instalar dependencias (usar pnpm para mejor performance)
RUN pnpm install --frozen-lockfile

# Copiar cÃ³digo fuente
COPY . .

# Build usando el comando especificado (por defecto build:prod)
RUN echo "ğŸš€ Ejecutando: pnpm run build:prod" && \
    pnpm run build:prod && \
    echo "âœ… Build completado."

# Verificar que el build fue exitoso
RUN echo "ğŸ” Verificando estructura final:" && \
    echo "ğŸ“‚ Contenido del directorio raÃ­z:" && ls -la . && \
    echo "" && \
    echo "ğŸ“‚ Estructura completa de dist:" && \
    (ls -laR dist/ || echo "âŒ dist no existe") && \
    echo "" && \
    echo "ğŸ“‚ Buscando index.html:" && \
    (find . -name "index.html" || echo "âŒ No se encontrÃ³ index.html") && \
    echo "" && \
    echo "ğŸ“¦ VerificaciÃ³n completada"

# â”€â”€â”€â”€â”€ Stage 2: Production Nginx Server â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
FROM nginx:1.25-alpine AS production

# Instalar dependencias adicionales si es necesario
RUN apk add --no-cache \
    curl \
    && rm -rf /var/cache/apk/*

# Copiar archivos built desde la stage anterior (Angular genera en dist/Frontend/browser con F mayÃºscula)
COPY --from=build /app/dist/Frontend/browser /usr/share/nginx/html

# Copiar configuraciÃ³n personalizada de nginx
COPY --from=build /app/docker/nginx.conf /etc/nginx/nginx.conf

# Configurar permisos bÃ¡sicos
RUN chmod -R 755 /usr/share/nginx/html

# Health check para monitoreo
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost/ || exit 1

# Exponer puerto 80
EXPOSE 80

# Comando por defecto
CMD ["nginx", "-g", "daemon off;"]
